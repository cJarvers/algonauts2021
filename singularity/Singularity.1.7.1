# based on https://github.com/manuel-munoz-aguirre/singularity-pytorch-gpu/blob/main/Singularity.1.0.0
Bootstrap: docker
From: nvidia/cuda:11.0.3-cudnn8-devel-ubuntu20.04

%labels
	Version 0.1.0
	MAINTAINER Daniel Schmid

# Copy project-specific requirements for later installation of dependencies
%files
	requirements.txt


%post
	# Update package lists
	apt-get update -y

	# Installation of python
	DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
	python3-dev \
	python3-tk \
	python3-pip \
	python3-setuptools

	# Remove temporary stuff to reduce image size
	rm -rf /var/lib/apt/lists/*

	# Update pip
	python3 -m pip install --upgrade pip

	# Installation of python libraries
	python3 -m pip install wheel

	# Installation of pytorch and torchvision fitting our cluster's CUDA versions
	python3 -m pip install torch==1.7.1+cu110 -f https://download.pytorch.org/whl/torch_stable.html
	python3 -m pip install torchvision==0.8.2+cu110 -f https://download.pytorch.org/whl/torch_stable.html

	# Taken from https://github.com/hpcng/singularity/issues/1616#issuecomment-502323549 to fix permissions enabling
	# execution on our cluster
	# TODO: check whether these are really needed
	chmod -R 777 /opt
    chmod -R 755 /root
    touch /bin/nvidia-smi #these commands and below have to do with using Nvidia drivers
    touch /usr/bin/nvidia-smi
    touch /usr/bin/nvidia-debugdump
    touch /usr/bin/nvidia-persistenced
    touch /usr/bin/nvidia-cuda-mps-control
    touch /usr/bin/nvidia-cuda-mps-server
    mkdir /etc/dcv
    mkdir /var/lib/dcv-gl

	# Installation of further project-specific requirements
	python3 -m pip install -r requirements.txt

	# Remove the artifacts needed for building again
	rm requirements.txt